<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ak Message Smart AES Processor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles for better visual feedback */
        /* Define the pulse animation for the password highlight */
        @keyframes pulse-highlight {
            0%, 100% { box-shadow: 0 0 0 rgba(239, 68, 68, 0); }
            50% { box-shadow: 0 0 15px rgba(239, 68, 68, 0.7); }
        }
        .highlight {
            border-color: #ef4444 !important; /* Tailwind red-500 */
            animation: pulse-highlight 1.5s infinite alternate;
        }
        /* Custom scrollbar for better aesthetics */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        /* Ensure font-inter is used globally */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900 min-h-screen flex justify-center items-start pt-10 sm:items-center sm:pt-0 p-4 font-sans text-gray-100">

    <div class="w-full max-w-xl bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-700">
        
        
        <p class="text-sm text-gray-400 text-center mb-6">Encrypt & Decrypt Secure Messages</p>

        <div id="status-box" class="bg-blue-900/50 border border-blue-600 text-blue-300 p-3 rounded-lg text-sm text-center font-medium">
            Status: Ready
        </div>

        <div id="password-section" class="border-2 border-gray-600 p-4 rounded-xl mt-6 transition-all duration-300">
            <label for="password-input" class="block mb-2 text-sm font-medium text-gray-300">Optional Password:</label>
            <input 
                type="password" 
                id="password-input" 
                placeholder="Set/Enter Password" 
                oninput="autoProcessMessage()"
                class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500 transition-colors"
            >
        </div>

        <label for="message-input-field" class="block mt-6 mb-2 text-sm font-medium text-gray-300">Message Input (Plain Text or Encrypted Code):</label>
        <textarea 
            id="message-input-field" 
            rows="6" 
            placeholder="Type or paste your message here..." 
            oninput="autoProcessMessage()"
            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none"
        ></textarea>
        
        <div id="share-buttons-container" class="flex gap-4 mt-4" style="display:none;">
            <button id="share-link-button" onclick="copyEncryptedLink()" class="flex-1 flex items-center justify-center p-3 rounded-lg text-white font-semibold transition-all duration-200 bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-500/50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M12 4.293l4.707 4.707a1 1 0 010 1.414L12 15.707V13H8a1 1 0 01-1-1v-4a1 1 0 011-1h4V4.293z"/><path fill-rule="evenodd" d="M11 2a1 1 0 00-1 1v2H7a3 3 0 00-3 3v4a3 3 0 003 3h3v2a1 1 0 001 1h5a1 1 0 001-1V3a1 1 0 00-1-1h-5zM15 13h-4v-2h4v2zm0-4h-4V7h4v2z" clip-rule="evenodd"/></svg>
                Copy Link
            </button>
            <button id="share-whatsapp-button" onclick="sendWhatsAppLink()" class="flex-1 flex items-center justify-center p-3 rounded-lg text-white font-semibold transition-all duration-200 bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-500/50">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5 mr-2"><path d="M.8 21.6l1.3-4.9c-.3-.8-.5-1.7-.5-2.6C1.6 8.5 7.1 3 13.7 3c3.2 0 6.2 1.3 8.5 3.6 2.3 2.3 3.6 5.3 3.6 8.5 0 6.6-5.5 12.1-12.1 12.1-1.7 0-3.3-.4-4.8-1.2l-5 1.3.8-.8zm1.9-4.8l.5 1.5.3.8c1.3.7 2.8 1.1 4.4 1.1 5.7 0 10.3-4.6 10.3-10.3 0-2.8-1.1-5.5-3.1-7.5-2-2-4.7-3.1-7.5-3.1-5.7 0-10.3 4.6-10.3 10.3 0 1.4.3 2.8.8 4.1zM17.4 15c-.2 0-.4-.1-.5-.2l-.4-.2c-.8-.4-1.6-.7-2.4-1-.8-.3-1.6-.5-2.3-.5-.7 0-1.4.2-2.1.5-.7.3-1.3.7-1.9 1.1-.6.4-1.1.9-1.5 1.4-.4.5-.7 1.1-.9 1.7-.2.6-.3 1.2-.3 1.8 0 .6.1 1.2.3 1.8s.6 1.1 1.1 1.5c.5.4 1.1.7 1.7.8.6.1 1.2.2 1.8 0h.4c.6-.1 1.2-.3 1.8-.6.6-.3 1.2-.7 1.6-1.2.4-.5.7-1.1.8-1.7s.2-1.2 0-1.8c-.1-.6-.4-1.2-.7-1.7-.3-.5-.7-.9-1.2-1.2-.5-.3-1.1-.5-1.7-.6z"/></svg>
                Share on WhatsApp
            </button>
        </div>

        <label class="block mt-6 mb-2 text-sm font-medium text-gray-300">Result (Encrypted or Decoded):</label>
        <div id="message-show-field" class="bg-gray-700 border border-gray-600 p-4 min-h-[5rem] mt-2 rounded-lg break-words font-mono text-gray-200 whitespace-pre-wrap text-sm">
            </div>

        <div id="toast-container" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50"></div>
    </div>

    <script>
        // --- Configuration Constants ---
        const IV_LENGTH = 12; 
        const TAG_LENGTH = 96; 
        // Base URL for the generated link
        const BASE_URL = 'https://encmsg.pages.dev'; 

        const KEY_DERIVATION_ALGO = {
            name: "PBKDF2",
            salt: new Uint8Array([73, 73, 73, 73, 73, 73, 73, 73, 73, 73, 73, 73, 73, 73, 73, 73]), 
            iterations: 100000,
            hash: "SHA-256",
        };
        const AES_ALGO = {
            name: "AES-GCM",
            length: 256
        };

        // --- Helper Functions ---

        /** Shows a non-blocking toast notification. */
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let bgColor;
            let icon;
            
            if (type === 'success') {
                bgColor = 'bg-green-500';
                icon = '‚úÖ';
            } else if (type === 'error') {
                bgColor = 'bg-red-500';
                icon = '‚ùå';
            } else {
                bgColor = 'bg-blue-500';
                icon = '‚ÑπÔ∏è';
            }
            
            toast.className = `p-3 rounded-lg shadow-xl text-white font-medium mb-3 transition-opacity duration-300 ${bgColor}`;
            toast.innerHTML = `${icon} ${message}`;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(10px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function str2ab(str) {
            const buf = new ArrayBuffer(str.length);
            const bufView = new Uint8Array(buf);
            for (let i = 0, strLen = str.length; i < strLen; i++) {
                bufView[i] = str.charCodeAt(i);
            }
            return buf;
        }

        function ab2b64(buffer) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)));
        }

        function b642ab(b64) {
            try {
                return str2ab(atob(b64));
            } catch (e) {
                console.error(" decoding error:", e);
                return new ArrayBuffer(0); // Return empty buffer on failure
            }
        }

        async function getCryptoKey(password) {
            if (!password) {
                return null;
            }
            const passwordBuffer = str2ab(password);
            const keyMaterial = await crypto.subtle.importKey(
                "raw",
                passwordBuffer,
                { name: "PBKDF2" },
                false,
                ["deriveKey"]
            );
            return crypto.subtle.deriveKey(
                KEY_DERIVATION_ALGO,
                keyMaterial,
                AES_ALGO,
                true,
                ["encrypt", "decrypt"]
            );
        }
        
        // --- Core Logic ---
        
        /** Generates the full encrypted link from the output field. */
        function generateEncryptedLink() {
            const messageShowField = document.getElementById('message-show-field');
            // Check if the output is an encrypted code (simple check for now)
            const encryptedOutput = messageShowField.innerText.trim().split('\n').pop();
            
            if (encryptedOutput && encryptedOutput.startsWith('enc?')) {
                const encodedMessage = encodeURIComponent(encryptedOutput);
                // Use the configured BASE_URL
                return `${BASE_URL}?enc=${encodedMessage}`; 
            }
            return null;
        }


        // =========================================================
        // 1. Automatic Process (Encode/Decode) Function (ASYNC)
        // =========================================================
        async function autoProcessMessage() {
            const messageInput = document.getElementById('message-input-field');
            const encryptedText = messageInput.value.trim();
            
            const messageShowField = document.getElementById('message-show-field');
            const passwordSection = document.getElementById('password-section');
            const shareContainer = document.getElementById('share-buttons-container');
            const statusBox = document.getElementById('status-box');

            if (!encryptedText) {
                messageShowField.innerHTML = '';
                passwordSection.classList.remove('highlight');
                shareContainer.style.display = 'none';
                statusBox.innerHTML = 'Status: Ready';
                return;
            }

            statusBox.innerHTML = 'Status: Processing...';

            if (encryptedText.startsWith('enc?')) {
                await decodeMessageLogic(encryptedText);
            } else {
                await encodeMessageLogic(encryptedText);
            }
            statusBox.innerHTML = 'Status: Done';
        }
        
        // =========================================================
        // 2. Encode Logic (ASYNC)
        // =========================================================
        async function encodeMessageLogic(message) {
            const passwordInput = document.getElementById('password-input');
            const messageShowField = document.getElementById('message-show-field');
            const passwordSection = document.getElementById('password-section');
            const shareContainer = document.getElementById('share-buttons-container');
            
            passwordSection.classList.remove('highlight');
            shareContainer.style.display = 'none';
            
            const password = passwordInput.value.trim();
            const key = await getCryptoKey(password);
            
            let finalEncryptedMessage;

            if (key) {
                try {
                    const iv = crypto.getRandomValues(new Uint8Array(IV_LENGTH)); 
                    const encodedMessage = str2ab(message);
                    const ciphertext = await crypto.subtle.encrypt(
                        { name: "AES-GCM", iv: iv, tagLength: TAG_LENGTH }, 
                        key,
                        encodedMessage
                    );

                    const fullEncryptedBuffer = new Uint8Array(iv.length + ciphertext.byteLength);
                    fullEncryptedBuffer.set(iv, 0);
                    fullEncryptedBuffer.set(new Uint8Array(ciphertext), iv.length);
                    
                    const encryptedPayload = ab2b64(fullEncryptedBuffer.buffer);
                    finalEncryptedMessage = `enc?AES_${encryptedPayload}`;

                    messageShowField.innerHTML = `<span class="text-blue-400 font-bold"></span><span class="text-gray-100">${finalEncryptedMessage}</span>`;
                    
                    shareContainer.style.display = 'flex';

                } catch(e) {
                    messageShowField.innerHTML = `<span class="text-red-500 font-bold">‚ùå ENCRYPTION ERROR:</span> ${e.message}`;
                    return;
                }
            } else {
                const simpleEncodedMessage = btoa(message);
                finalEncryptedMessage = `enc?B64_${simpleEncodedMessage}`;

                messageShowField.innerHTML = `<span class="text-yellow-400 font-bold"></span><span class="text-gray-100">${finalEncryptedMessage}</span>`;
                
                shareContainer.style.display = 'flex';
            }
        }
        
        // =========================================================
        // 3. Decode Logic (ASYNC)
        // =========================================================
        async function decodeMessageLogic(encryptedText) {
            const passwordInput = document.getElementById('password-input');
            const messageShowField = document.getElementById('message-show-field');
            const passwordSection = document.getElementById('password-section');
            const shareContainer = document.getElementById('share-buttons-container');
            
            messageShowField.innerHTML = ''; 
            passwordSection.classList.remove('highlight'); 
            shareContainer.style.display = 'none';

            const content = encryptedText.substring(4); 

            if (content.startsWith('AES_')) {
                // --- AES DECRYPTION ---
                
                const encryptedPayload = content.substring(4); 
                const password = passwordInput.value.trim();
                
                if (!password) {
                    passwordSection.classList.add('highlight');
                    messageShowField.innerHTML = '<span class="text-red-400 font-bold">‚ö†Ô∏è ENCRYPTED:</span> <span class="text-gray-300">Please enter the correct password to decode.</span>';
                    return;
                }
                
                try {
                    const fullEncryptedBuffer = b642ab(encryptedPayload);
                    if (fullEncryptedBuffer.byteLength < IV_LENGTH) throw new Error("Invalid encrypted data length.");
                    
                    const iv = new Uint8Array(fullEncryptedBuffer, 0, IV_LENGTH); 
                    const ciphertext = new Uint8Array(fullEncryptedBuffer, IV_LENGTH); 

                    const key = await getCryptoKey(password);
                    
                    const decrypted = await crypto.subtle.decrypt(
                        { name: "AES-GCM", iv: iv, tagLength: TAG_LENGTH },
                        key,
                        ciphertext
                    );
                    
                    const originalMessage = new TextDecoder().decode(decrypted);

                    messageShowField.innerHTML = `<span class="text-green-400 font-bold"></span><span class="text-gray-100">${originalMessage}</span>`;
                    passwordSection.classList.remove('highlight'); 

                } catch (e) {
                    passwordSection.classList.add('highlight');
                    messageShowField.innerHTML = '<span class="text-red-500 font-bold">‚ùå DECRYPTION FAILED.</span> <span class="text-gray-300">The password might be incorrect or the message is corrupted.</span>';
                }

            } else if (content.startsWith('B64_')) {
                // --- B64 DECRYPTION ---
                
                const simpleEncodedMessage = content.substring(4);
                
                try {
                    const originalMessage = atob(simpleEncodedMessage);
                    messageShowField.innerHTML = `<span class="text-green-400 font-bold">üîì DECODED MESSAGE (B64):</span>\n<span class="text-gray-100">${originalMessage}</span>`;
                } catch (e) {
                     messageShowField.innerHTML = '<span class="text-red-500 font-bold">‚ùå DECODING FAILED.</span> <span class="text-gray-300">Invalid  format.</span>';
                }

            } else {
                messageShowField.innerHTML = '<span class="text-red-500 font-bold">‚ùå UNKNOWN FORMAT.</span> <span class="text-gray-300">Input does not match expected "enc?" format.</span>';
            }
        }
        
        // =========================================================
        // 4. Copy Encrypted Link
        // =========================================================
        function copyEncryptedLink() {
            const encryptedLink = generateEncryptedLink();
            
            if (encryptedLink) {
                // Use execCommand for better compatibility in limited iFrame environments
                const tempInput = document.createElement('input');
                tempInput.value = encryptedLink;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);

                showToast('Link copied to clipboard!', 'success');
            } else {
                showToast('Please encrypt a message first.', 'error');
            }
        }
        
        // =========================================================
        // 5. Share on WhatsApp
        // =========================================================
        function sendWhatsAppLink() {
            const encryptedLink = generateEncryptedLink();
            
            if (encryptedLink) {
                const message = encodeURIComponent(`${encryptedLink}`);
                
                // WhatsApp share URL
                const whatsappUrl = `https://wa.me/?text=${message}`;
                
                window.open(whatsappUrl, '_blank');
            } else {
                showToast('Please encrypt a message first.', 'error');
            }
        }


        // =========================================================
        // 6. Check URL parameters on page load
        // =========================================================
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const encryptedMessageFromUrl = urlParams.get('enc');
            const statusBox = document.getElementById('status-box');

            if (encryptedMessageFromUrl) {
                statusBox.innerHTML = 'Status: Encrypted message loaded...'; // Initial status
                const decodedMessage = decodeURIComponent(encryptedMessageFromUrl);
                const messageInputField = document.getElementById('message-input-field');
                
                messageInputField.value = decodedMessage; // Populate input field
                
                // Start automatic processing
                autoProcessMessage();

                // Show a brief message to the user
                showToast('Encrypted message loaded from URL. Enter password to decode.', 'info');
            }
        });
    </script>
</body>
</html>
